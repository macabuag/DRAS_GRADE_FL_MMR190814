# Title: Vulnerability_FL.r
# By: Josh Macabuag
# Date: 14-Aug-2019
# Description:
# - read GAR country exposures to create a combined dataframe.
# - do sense-checks on the exposure
# - read all GAR (CAPRA for LAC) vulnerabilities
# - do sense checks on the vulnerabilities
# - read UCL vulnerabilities
# - compare GAR VFs with UCL VFs


## 1.0 SETUP -----------------------------------------------------------

## User-Defined Values --

## Input Files --
iFile <- list()

iFile$vulnFolder$FL <- file.path("..","..","1-data", "Vulnerability", "CAPRA", "Flood")
iFile$vulnFolder$FL_GA <- file.path("..","..","1-data", "Vulnerability", "CAPRA", "Flood Geoscience Australia")


# iFile$vulnFolder <- file.path("inputs", "vuln")
# iFile$VulEqLAC <- "VulEqLAC.dat"
# iFile$GARConClasses <- file.path("inputs","GAR Construction Classes.txt")



#iFile$periodIDs <- file.path("inputs", "GAR2015 PeriodIDs.csv")


## Packages --
if(!require(data.table)) {
  install.packages("data.table")
  library(data.table)
}

if(!require(ggplot2)) {
  install.packages("ggplot2")
  library(ggplot)
}

if(!require(stringr)){
  install.packages("stringr")
  library(stringr)
}

if(!require(tidyr)){
  install.packages("tidyr")
  library(tidyr)
}

if(!require(sf)){
  install.packages("sf")
  library(sf)
}


## Output Folder --
oFolder <- paste0(gsub("[[:punct:]]", " ", Sys.time()), "-FL_VFs")  #create a unique folder with the run date


## 2.1 GAR VULNERABILITIES ------------------------------------------------------

## Read GAR Vulnerability Summary Table ##
VF <- list()

VF$CAPRA$VF <- 
  
  VF$GAR$conClassDescr <- fread(iFile$GARConClasses)
VF$GAR$expVFmapping <- fread(file.path(iFile$vulnFolder, iFile$VulEqLAC))
colnames(VF$GAR$expVFmapping) <- c("SE_SISMO","PeriodID","fileName")

## link each VF with PeriodId
b <- unique(VF$GAR$expVFmapping[,.(fileName, PeriodID)])
b <- b[,.N, by=.(fileName, PeriodID)]
if(any(b$N>1)) warning("Multiple periodIDs assigned to a single VF")


## link each VF with Period
VF$GAR$periodIDs <- fread(iFile$periodIDs)
c <- merge(x = b, VF$GAR$periodIDs[,.(PeriodId,Period, PeriodUnits=Units)],
           by.x="PeriodID", by.y="PeriodId")


## Add constructions and ductility level to VF descriptions
#c <- VF$GAR$VFdescr
c <- separate(data = c, col = fileName, sep = "_", 
              into = c("peril", "BS_TYPE", "Quality"),remove=F) %>%
  separate(col = Quality, into=c("Quality","units")) 


## add construction type descriptions
VF$GAR$VFdescr <- merge(c, VF$GAR$conClassDescr,
                        by.x="BS_TYPE", by.y="Structuralsystem")

rm(b,c)



## Read GAR Vulnerability Curves ##
## List the filenames for all curves
VF$CAPRA$FL$fileNames <- list.files(path = iFile$vulnFolder$FL, pattern = "\\.fvu$") #list all vulnerability files with extension '.fvu'
VF$CAPRA$FL_GA$fileNames <- list.files(path = iFile$vulnFolder$FL_GA, pattern = "\\.fvu$") #list all vulnerability files with extension '.fvu'




## Read all curves
for (iVF in VF$GAR$fileNames) {
  a <- fread(file.path(iFile$vulnFolder, iVF),
             col.names = c("IM", "MDR","SD"))
  
  #add fileName and extract info
  a$fileName <- iVF
  b <- separate(data = a, col = fileName, sep = "_", 
                into = c("peril", "BS_TYPE", "Quality"),remove=F) %>%
    separate(col = Quality, into=c("Quality","units"))
  VF$GAR$curves[[iVF]] <- b
  
  rm(a,b)
}

## Combine curveData
VF$GAR$combined <- rbindlist(l = VF$GAR$curves)


VF$GAR$combined <- merge(VF$GAR$combined,
                         VF$GAR$conClassDescr,
                         by.x = "BS_TYPE", by.y = "Structuralsystem")
VF$GAR$combined <- merge(VF$GAR$combined, VF$GAR$VFdescr[,.(fileName, Period)],
                         by="fileName")

VF$GAR$gg <- melt(VF$GAR$combined, measure.vars = c("MDR","SD"))

## Summary Stats
VF$GAR$uniqueValues <- apply(X = VF$GAR$gg[,peril:variable], MARGIN = 2, FUN = unique)
VF$GAR$count <- length(VF$GAR$curves)


## Visualize ##
VF$GAR$plots$all <- ggplot(VF$GAR$gg, aes(IM, value)) + 
  geom_line(aes(colour=fileName, linetype=variable)) + 
  facet_grid(Quality ~ BS_TYPE) +
  coord_cartesian(expand = F) +
  theme_bw() +
  theme(legend.position = "none")
#VF$GAR$plots$all

VF$GAR$plots$BS_TYPE$allDev <- ggplot(VF$GAR$gg[variable=="MDR"], aes(IM, value)) + 
  geom_line(aes(colour=BS_TYPE)) + 
  facet_grid(. ~ Quality) +
  coord_cartesian(xlim=c(0,1500),expand = F) +
  labs(x=unique(VF$GAR$gg$units), y="MDR") +
  theme_bw()
#VF$GAR$plots$BS_TYPE$allDev

VF$GAR$plots$BS_TYPE$M <- ggplot(VF$GAR$gg[variable=="MDR" & Quality=="M"],
                                 aes(IM, value)) + 
  geom_line(aes(colour=BS_TYPE)) + 
  facet_grid(. ~ Quality) +
  coord_cartesian(xlim=c(0,1500),expand = F) +
  labs(x=unique(VF$GAR$gg$units), y="MDR", title="Effect of Construction Class") +
  theme_bw()
#VF$GAR$plots$BS_TYPE$M


#Sensitivity Test: Construction Class
VF$GAR$plots$sensitivity$BS_TYPE <- ggplot(VF$GAR$gg[Quality %in% c("L","H") &
                                                       BS_TYPE %in% c("A", "C", "INF", "M", "S", "UCB","W")],
                                           aes(IM, value)) + 
  geom_line(aes(colour=Description, linetype=variable)) + 
  facet_grid(. ~ Quality) +
  coord_cartesian(xlim=c(0,1500),expand = F) +
  labs(x=unique(VF$GAR$gg$units), y="MDR", 
       title="Sensitivity Test: Construction Class",
       subtitle = "GAR (all countries)") +
  theme_bw()
#VF$GAR$plots$sensitivity$BS_TYPE

#Sensitivity Test: Construction Quality
VF$GAR$plots$sensitivity$Quality <- ggplot(VF$GAR$gg[Quality %in% c("P","L","M","H") &
                                                       BS_TYPE %in% c("C", "INF", "W")],
                                           aes(IM, value)) + 
  #                                                   BS_TYPE %in% c("A", "C", "INF", "M", "S", "W")],
  geom_line(aes(colour=Quality, linetype=variable)) + 
  facet_grid(Period ~ word(Description, end = 1)) +
  coord_cartesian(xlim=c(0,1500),expand = F) +
  labs(x=unique(VF$GAR$gg$units), y="MDR", 
       title="Sensitivity Test: Construction Quality", 
       subtitle = paste0("GAR (all countries)\nVF$GAR$plots$sensitivity$Quality")) +
  theme_bw()
#VF$GAR$plots$sensitivity$Quality


VF$GAR$plots$Quality$C <- ggplot(VF$GAR$gg[variable=="MDR" & BS_TYPE=="C"],
                                 aes(IM, value)) + 
  geom_line(aes(colour=Quality)) + 
  facet_grid(. ~ BS_TYPE) +
  coord_cartesian(xlim=c(0,1500),expand = F) +
  labs(x=unique(VF$GAR$gg$units), y="MDR",title="Effect of Quality") +
  theme_bw()
#VF$GAR$plots$Quality$C



## 2.2 GAR EXPOSURES ------------------------------------------------------------------
exp <- list()

#read shapefile within each *.tar file:
for (iCntryFile in list.files(path = iFile$expFolder, pattern = "*.tar")) {
  #ToDo: #update to output toan output folder
  untar(tarfile = file.path(iFile$expFolder, iCntryFile), 
        exdir = file.path("outputs", oFolder)) 
  
  ## Read shapefile
  a <- st_read(dsn = file.path("outputs", oFolder, paste0(word(string = iCntryFile, sep = "\\."),".dbf")))
  
  ## Extract attributes
  b <- as.data.table(a)
  
  if(!("SE_SISMO" %in% colnames(b))) {next}
  
  #add period to exposure data
  c <- merge(b, VF$GAR$expVFmapping, by = "SE_SISMO")
  b <- merge(c, VF$GAR$periodIDs[,.(PeriodId, Period)],
             by.x="PeriodID", by.y="PeriodId")
  
  ## save country VF data
  d <- unique(b$fileName)
  e <- VF$GAR$VFdescr[fileName %in% d]
  iCntry <- toString(unique(b$COUNTRY))
  VF$GAR$cntry[[iCntry]] <- cbind(COUNTRY = iCntry, e)
  
  ## save country exposure data
  exp$GAR$cntry[[iCntry]]$shapeFile <- a
  exp$GAR$cntry[[iCntry]]$data <- b
  
  ## Checks & Summary Stats ##
  exp$GAR$cntry[[iCntry]]$uniqueValues <- sapply(b[,CPX:USE_CLASS],FUN = unique)
  exp$GAR$cntry[[iCntry]]$countSismo <- length(unique(b$SE_SISMO))
  exp$GAR$cntry[[iCntry]]$countVF <- length(unique(b$fileName))
  
  rm(a,b,c,d,e)
}

## plot ##
#subset
VF$GAR$plots$cntry$JAM$data <- VF$GAR$gg[fileName %in% unique(exp$GAR$cntry$JAM$data$fileName)] #VF$GAR$gg has all 79 seismic vulnerability functions. So just subset for the country of interest

VF$GAR$plots$cntry$JAM$fig <- ggplot(VF$GAR$plots$cntry$JAM$data[variable=="MDR"]) +
  geom_line(aes(x=IM, y=value, colour=Description)) + 
  facet_grid(Period ~ Quality) +
  coord_cartesian(xlim=c(0,1500),expand = F) +
  labs(x=unique(VF$GAR$gg$units), y="MDR", title="All Jamaica VFs (GAR)") +
  theme_bw()
VF$GAR$plots$cntry$JAM$fig


## 2.3 SUMMARIZE GAR VFs & EXOPSUREs ------------------------------------------------------------------

## Lists the VFs for Each Country
VF$GAR$combSummary <- rbindlist(VF$GAR$cntry)

## Summarize VF & Exposure Info for each country (one row per country)
a <- VF$GAR$combSummary[,.(nBS_TYPE=length(unique(BS_TYPE)),
                           BS_TYPEs=paste0(unique(BS_TYPE), collapse = ","),
                           nQuality=length(unique(Quality)),
                           Qualities_VF=paste0(unique(Quality),collapse = ","),
                           nPeriod=length(unique(Period)),
                           Periods_VF=paste0(unique(Period),collapse = ","),
                           nVFs=.N),
                        by=COUNTRY]

## Total no. of exposure classes/country
b <- sapply(exp$GAR$cntry, FUN = function(x) {x$countSismo})
b <- data.table(COUNTRY=names(b),nBS_SISMO=b)

## Total no. of complexity classes/country
c <- sapply(exp$GAR$cntry, FUN = function(x) {paste0(x$uniqueValues$CPX, collapse = ",")})
c <- data.table(COUNTRY=names(c), CPXs_exp=c)

## Total no. of use_sectors/country
d <- sapply(exp$GAR$cntry, FUN = function(x) {paste0(x$uniqueValues$USE_SECTOR, collapse = ",")})
e <- sapply(exp$GAR$cntry, FUN = function(x) {length(unique(x$uniqueValues$USE_SECTOR))})
d <- data.table(COUNTRY=names(d), nUSE_SECTOR=e, USE_SECTORs=d)

## combine
f <- merge(a,b, by="COUNTRY")
f <- merge(f,c, by="COUNTRY")
f <- merge(f,d, by="COUNTRY")

exp$GAR$cntrySummary <- f
VF$GAR$cntrySummary <- exp$GAR$summary

rm(a,b,c,d,e,f)

# sapply(exp$GAR$cntry, FUN = function(x) {
#   sapply(x$uniqueValues, FUN = function(y) paste0(y, collapse = ","))})





## 4.0 READ UCL VULNERABILITIES --
dir.create(path = file.path("outputs",oFolder))



## 3.0 CHECKS AND SUMMARY STATS --------------------------------------

## 4.0 COMBINE DATABASES ---------------------------------------------- 

## 5.0 VISUALIZE ------------------------------------------------------
#GAR Jamaica VFs

## 6.0 GLOBAL CHECKS --------------------------------------------------
# CAPRA sense-checks

## Affect of Construction


## Affect of Occupancy


## Affect of #storeys

## 7.0 COUNTRY CHECKS ------------------------------------------------
# Compare CAPRA for country with UCL empirical curves